# ssh
- name: Include ssh vault
  tags: ssh
  include_vars:
    file: vault.yaml
  no_log: True

- name: Copy ssh key id_rsa
  tags: ssh
  copy:
    content: "{{ mbp_id_rsa }}"
    dest: /home/{{ ansible_user}}/.ssh/mbp_id_rsa
    mode: 0600
    owner: "{{ ansible_user }}"
  no_log: True

- name: Copy ssh key id_rsa.pub
  tags: ssh
  copy:
    content: "{{ mbp_id_rsa_pub }}"
    dest: /home/{{ ansible_user}}/.ssh/mbp_id_rsa.pub
    mode: 0644
    owner: "{{ ansible_user }}"
  no_log: True

- name: Create ssh config
  tags: ssh
  file:
    path: /home/{{ ansible_user }}/.ssh/config
    state: touch
    owner: "{{ ansible_user }}"
    group: "{{ ansible_user }}"
    mode: 0644
  no_log: True

- name: Add mbp_id_rsa to ssh config
  tags: ssh
  lineinfile:
    line: " IdentityFile /home/{{ ansible_user }}/.ssh/mbp_id_rsa"
    dest: /home/{{ ansible_user }}/.ssh/config
    mode: 0644
    owner: "{{ ansible_user }}"
  no_log: True

- name: Add mbp_id_rsa_pub to authorized_keys
  tags: ssh
  lineinfile:
    line: "{{ mbp_id_rsa_pub }}"
    dest: /home/{{ ansible_user }}/.ssh/authorized_keys
    mode: 0644
    owner: "{{ ansible_user }}"
  no_log: True

- name: Add github to known_hosts
  tags: ssh
  lineinfile:
    line: "{{ lookup('pipe', 'ssh-keyscan -t rsa github.com') }}"
    dest: /home/{{ ansible_user }}/.ssh/known_hosts
    mode: 0644
    owner: "{{ ansible_user }}"
    create: True
  no_log: True
